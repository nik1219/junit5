package org.junit.platform.reporting.open.xml;

import org.junit.platform.engine.TestExecutionResult;
import org.junit.platform.launcher.TestExecutionListener;
import org.junit.platform.launcher.TestIdentifier;
import org.junit.platform.launcher.TestPlan;
import org.opentest4j.reporting.EventReportFileWriter;

import javax.xml.stream.XMLStreamException;
import java.io.IOException;
import java.io.UncheckedIOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.Instant;

public class OpenTestReportGeneratingListener implements TestExecutionListener {

    private final Path reportDir;
    private EventReportFileWriter eventWriter;

    public OpenTestReportGeneratingListener() {
        this(lookupReportDirFromSystemProperties());
    }

    private static Path lookupReportDirFromSystemProperties() {
        String reportDir = System.getProperty("junit.platform.reports.dir");
        return reportDir != null ? Paths.get(reportDir) : null;
    }

    public OpenTestReportGeneratingListener(Path reportDir) {
        this.reportDir = reportDir;
    }

    @Override
    public void testPlanExecutionStarted(TestPlan testPlan) {
        if (reportDir != null) {
            try {
                Files.createDirectories(reportDir);
                eventWriter = new EventReportFileWriter(reportDir.resolve("junit-platform-events-" + System.currentTimeMillis() + ".xmlstream"));
            } catch (IOException | XMLStreamException e) {
                throw new RuntimeException("Failed to close XML events file", e);
            }
        }
    }

    @Override
    public void testPlanExecutionFinished(TestPlan testPlan) {
        if (eventWriter != null) {
            try {
                eventWriter.close();
            } catch (IOException e) {
                throw new UncheckedIOException("Failed to close XML events file", e);
            } finally {
                eventWriter = null;
            }
        }
    }

    @Override
    public void executionStarted(TestIdentifier testIdentifier) {
        try {
            eventWriter.started(testIdentifier.getUniqueId(), Instant.now());
        } catch (IOException | XMLStreamException e) {
            throw new RuntimeException("Failed to write started event", e);
        }
    }

    @Override
    public void executionFinished(TestIdentifier testIdentifier, TestExecutionResult testExecutionResult) {
        try {
            eventWriter.finished(testIdentifier.getUniqueId(), Instant.now());
        } catch (IOException | XMLStreamException e) {
            throw new RuntimeException("Failed to write finished event", e);
        }
    }
}
